import { Button } from "@/components/ui/button";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import { Download, FileText, Settings } from "lucide-react";
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';
import { MicroRegionData } from "@/types/dashboard";
import { useState } from "react";

interface DownloadPDFProps {
  selectedData: MicroRegionData;
  data: MicroRegionData[];
  selectedMicroregiao: string;
}

interface SectionOption {
  id: string;
  label: string;
  checked: boolean;
}

export function DownloadPDF({ selectedData, data, selectedMicroregiao }: DownloadPDFProps) {
  const [isOpen, setIsOpen] = useState(false);
  const [sections, setSections] = useState<SectionOption[]>([
    { id: 'stats', label: 'Estat√≠sticas Gerais', checked: true },
    { id: 'radar', label: 'Gr√°fico Radar (Compara√ß√£o por Eixos)', checked: true },
    { id: 'bar', label: 'Gr√°fico de Barras (Ranking)', checked: true },
    { id: 'table', label: 'Tabela de Eixos', checked: true },
    { id: 'population', label: 'Gr√°fico de Popula√ß√£o', checked: true },
    { id: 'recommendations', label: 'Recomenda√ß√µes por Eixo', checked: true },
    { id: 'executive', label: 'Dashboard Executivo', checked: true },
    { id: 'advanced', label: 'An√°lise Avan√ßada', checked: true },
    { id: 'eixos-detail', label: 'Detalhamento por Eixos de Maturidade', checked: true },
  ]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [generationProgress, setGenerationProgress] = useState('');

  const handleSelectAll = (checked: boolean) => {
    setSections(sections.map(section => ({ ...section, checked })));
  };

  const handleSectionChange = (id: string, checked: boolean) => {
    setSections(sections.map(section => 
      section.id === id ? { ...section, checked } : section
    ));
  };

  const generatePDF = async () => {
    try {
      setIsGenerating(true);
      const selectedSections = sections.filter(s => s.checked);
      if (selectedSections.length === 0) {
        alert('Selecione pelo menos uma se√ß√£o para incluir no PDF.');
        setIsGenerating(false);
        return;
      }

      setGenerationProgress('Iniciando gera√ß√£o do PDF...');
      
      // Configura√ß√µes do PDF para A4
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      let currentPage = 1;
      const totalPages = selectedSections.length + 1; // +1 para p√°gina de capa

      // P√°gina de capa
      setGenerationProgress('Criando p√°gina de capa...');
      const coverPage = generateCoverPage();
      await addPageToPDF(pdf, coverPage, currentPage, totalPages);
      currentPage++;

      // Aguardar um pouco para garantir que os gr√°ficos sejam renderizados
      await new Promise(resolve => setTimeout(resolve, 500));

      // Adicionar se√ß√µes selecionadas (uma por p√°gina)
      for (const section of selectedSections) {
        try {
          setGenerationProgress(`Gerando se√ß√£o: ${section.label}...`);
          
          let sectionContent = '';
          switch (section.id) {
            case 'stats':
              sectionContent = generateStatsPage();
              break;
            case 'radar':
              sectionContent = await generateRadarPage();
              break;
            case 'bar':
              sectionContent = await generateBarPage();
              break;
            case 'table':
              sectionContent = generateTablePage();
              break;
            case 'population':
              sectionContent = await generatePopulationPage();
              break;
            case 'recommendations':
              sectionContent = generateRecommendationsPage();
              break;
            case 'executive':
              sectionContent = generateExecutivePage();
              break;
            case 'advanced':
              sectionContent = generateAdvancedPage();
              break;
            case 'eixos-detail':
              sectionContent = generateEixosDetailPage();
              break;
          }
          
          if (sectionContent) {
            setGenerationProgress(`Adicionando p√°gina ${currentPage} de ${totalPages}...`);
            await addPageToPDF(pdf, sectionContent, currentPage, totalPages);
            currentPage++;
          }
        } catch (error) {
          console.error(`Erro ao processar se√ß√£o ${section.id}:`, error);
        }
      }

      // Nome do arquivo
      setGenerationProgress('Finalizando e salvando PDF...');
      const fileName = `relatorio-maturidade-${selectedData.microrregiao.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
      pdf.save(fileName);
      setGenerationProgress('PDF gerado com sucesso!');
      
      setTimeout(() => {
        setIsGenerating(false);
        setGenerationProgress('');
        setIsOpen(false);
      }, 800);

    } catch (error) {
      console.error('Erro geral:', error);
      alert('Erro ao gerar relat√≥rio. Tente novamente.');
      setGenerationProgress('Erro na gera√ß√£o do PDF');
    } finally {
      setIsGenerating(false);
      setGenerationProgress('');
    }
  };

  const addPageToPDF = async (pdf: jsPDF, content: string, currentPage: number, totalPages: number) => {

    
    // Criar elemento tempor√°rio para a p√°gina
    const pageElement = document.createElement('div');
    pageElement.style.width = '210mm';
    pageElement.style.minHeight = '297mm';
    pageElement.style.padding = '20mm';
    pageElement.style.backgroundColor = 'white';
    pageElement.style.fontFamily = 'Arial, sans-serif';
    pageElement.style.fontSize = '12px';
    pageElement.style.lineHeight = '1.5';
    pageElement.style.position = 'absolute';
    pageElement.style.left = '-9999px';
    pageElement.style.top = '0';
    pageElement.style.color = '#000';

    // Adicionar conte√∫do da p√°gina
    pageElement.innerHTML = content;

    // Adicionar ao DOM temporariamente
    document.body.appendChild(pageElement);

    try {
      // Configura√ß√µes do html2canvas para melhor qualidade
      const canvas = await html2canvas(pageElement, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: pageElement.scrollWidth,
        height: pageElement.scrollHeight,
        scrollX: 0,
        scrollY: 0,
        logging: false,
        removeContainer: true,
        windowWidth: pageElement.scrollWidth,
        windowHeight: pageElement.scrollHeight
      });

      // Calcular dimens√µes para A4
      const imgWidth = 210; // Largura A4 em mm
      const pageHeight = 297; // Altura A4 em mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      // Adicionar p√°gina ao PDF
      if (currentPage > 1) {
        pdf.addPage();
      }
      
      // Adicionar imagem ao PDF - sempre usar altura completa para evitar cortes
      pdf.addImage(canvas, 'PNG', 0, 0, imgWidth, imgHeight);

    } catch (error) {
      console.error('Erro ao adicionar p√°gina ao PDF:', error);
    } finally {
      // Remover elemento tempor√°rio
      document.body.removeChild(pageElement);
    }
  };

  const generateCoverPage = () => `
    <div style="text-align: center; padding-top: 60px;">
      <h1 style="color: #1e40af; font-size: 32px; margin-bottom: 30px; font-weight: bold;">
        Relat√≥rio de Maturidade Digital
      </h1>
      <h2 style="color: #374151; font-size: 24px; margin-bottom: 20px; font-weight: bold;">
        Microrregi√£o: ${selectedData.microrregiao}
      </h2>
      <div style="background-color: #f8fafc; padding: 30px; border-radius: 8px; margin: 40px 0;">
        <p style="color: #6b7280; font-size: 18px; margin-bottom: 15px;">
          <strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}
        </p>
        <p style="color: #6b7280; font-size: 18px; margin-bottom: 15px;">
          <strong>√çndice Geral:</strong> ${parseFloat(String(selectedData.indice_geral).replace(',', '.')).toFixed(3)}
        </p>
        <p style="color: #6b7280; font-size: 18px;">
          <strong>Status:</strong> ${getStatusText(selectedData.indice_geral)}
        </p>
      </div>
      <p style="color: #6b7280; font-size: 16px; margin-top: 40px;">
        Gerado pelo Sistema de Monitoramento Regional
      </p>
    </div>
  `;

  const generateHeaderSection = () => `
    <div style="margin-bottom: 20px; page-break-inside: avoid;">
      <h3 style="color: #1e40af; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #1e40af; padding-bottom: 3px;">
        Informa√ß√µes Detalhadas da Microrregi√£o
      </h3>
      
      <!-- Informa√ß√µes Principais -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px; margin-bottom: 15px;">
        <div style="background-color: #f9fafb; padding: 8px; border-radius: 4px;">
          <strong>Macrorregi√£o:</strong> ${selectedData.macrorregiao}
        </div>
        <div style="background-color: #f9fafb; padding: 8px; border-radius: 4px;">
          <strong>Regional de Sa√∫de:</strong> ${selectedData.regional_saude}
        </div>
        <div style="background-color: #f9fafb; padding: 8px; border-radius: 4px;">
          <strong>Analista:</strong> ${selectedData.analista}
          ${selectedData.email_analista ? `<br/><small>${selectedData.email_analista}</small>` : ''}
        </div>
        <div style="background-color: #f9fafb; padding: 8px; border-radius: 4px;">
          <strong>Popula√ß√£o:</strong> ${selectedData.populacao} habitantes
        </div>
        <div style="background-color: #f9fafb; padding: 8px; border-radius: 4px;">
          <strong>IDH:</strong> ${selectedData.idh_completo}
        </div>
        <div style="background-color: #f9fafb; padding: 8px; border-radius: 4px;">
          <strong>Classifica√ß√£o INMSD:</strong> ${selectedData.classificacao_inmsd}
        </div>
      </div>

      <!-- Informa√ß√µes Adicionais -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 11px; margin-bottom: 15px;">
        <div style="background-color: #f0f9ff; padding: 8px; border-radius: 4px; border-left: 4px solid #1e40af;">
          <strong>Pontua√ß√£o Geral:</strong> ${selectedData.pontuacao_geral || 'N/A'}
        </div>
        <div style="background-color: #f0f9ff; padding: 8px; border-radius: 4px; border-left: 4px solid #1e40af;">
          <strong>Status INMSD:</strong> ${selectedData.status_inmsd || 'N/A'}
        </div>
      </div>

      <!-- Pontos Focais -->
      <div style="background-color: #f9fafb; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 11px;">
        <strong>Ponto Focal:</strong><br/>
        ${selectedData.ponto_focal || 'N/A'}
        ${selectedData.email_ponto_focal ? `<br/><strong>Email:</strong> ${selectedData.email_ponto_focal}` : ''}
      </div>

      <!-- √çndice Geral de Maturidade Digital -->
      <div style="margin-top: 10px; background-color: #eff6ff; padding: 15px; border-radius: 4px; text-align: center; border: 2px solid #1e40af;">
        <strong style="color: #1e40af; font-size: 18px;">
          √çndice Geral de Maturidade Digital: ${parseFloat(String(selectedData.indice_geral).replace(',', '.')).toFixed(3)}
        </strong>
      </div>

      <!-- Munic√≠pios da Microrregi√£o -->
      <div style="margin-top: 15px; background-color: #f9fafb; padding: 10px; border-radius: 4px; font-size: 11px;">
        <strong>Munic√≠pios da Microrregi√£o:</strong><br/>
        <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
          ${selectedData.municipios?.split(',').map(municipio => 
            `<span style="background-color: #e5e7eb; padding: 3px 8px; border-radius: 12px; font-size: 10px;">${municipio.trim()}</span>`
          ).join('') || 'N/A'}
        </div>
      </div>
    </div>
  `;

  const generateStatsSection = () => `
    <div style="margin-bottom: 20px; page-break-inside: avoid;">
      <h3 style="color: #1e40af; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #1e40af; padding-bottom: 3px;">
        Estat√≠sticas Gerais
      </h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; font-size: 11px;">
        <div style="background-color: #f0f9ff; padding: 10px; border-radius: 4px; text-align: center; border-left: 4px solid #1e40af;">
          <div style="font-size: 18px; font-weight: bold; color: #1e40af;">${data.length}</div>
          <div style="font-size: 10px; color: #6b7280;">Total de Microrregi√µes</div>
        </div>
        <div style="background-color: #f0f9ff; padding: 10px; border-radius: 4px; text-align: center; border-left: 4px solid #1e40af;">
          <div style="font-size: 18px; font-weight: bold; color: #1e40af;">${data.reduce((sum, item) => sum + parseInt(String(item.populacao).replace(/\./g, '')), 0).toLocaleString('pt-BR')}</div>
          <div style="font-size: 10px; color: #6b7280;">Popula√ß√£o Total</div>
        </div>
        <div style="background-color: #f0f9ff; padding: 10px; border-radius: 4px; text-align: center; border-left: 4px solid #1e40af;">
          <div style="font-size: 18px; font-weight: bold; color: #1e40af;">${(data.reduce((sum, item) => sum + parseFloat(String(item.indice_geral).replace(',', '.')), 0) / data.length).toFixed(3)}</div>
          <div style="font-size: 10px; color: #6b7280;">Maturidade M√©dia</div>
        </div>
        <div style="background-color: #f0f9ff; padding: 10px; border-radius: 4px; text-align: center; border-left: 4px solid #1e40af;">
          <div style="font-size: 18px; font-weight: bold; color: #1e40af;">${data.sort((a, b) => parseFloat(String(b.indice_geral).replace(',', '.')) - parseFloat(String(a.indice_geral).replace(',', '.'))).findIndex(item => item.microrregiao === selectedData.microrregiao) + 1}¬∫</div>
          <div style="font-size: 10px; color: #6b7280;">Posi√ß√£o no Ranking</div>
        </div>
      </div>
    </div>
  `;

  const generateRadarSection = async () => {
    const radarElement = document.querySelector('[data-chart="radar"]');
    if (radarElement && (radarElement as HTMLElement).offsetWidth > 0) {
      try {
        const canvas = await html2canvas(radarElement as HTMLElement, {
          scale: 2, // Aumentado para melhor qualidade
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: (radarElement as HTMLElement).offsetWidth,
          height: (radarElement as HTMLElement).offsetHeight,
          scrollX: 0,
          scrollY: 0,
          logging: false,
          removeContainer: true
        });
        
        // Criar um canvas maior para incluir o t√≠tulo
        const finalCanvas = document.createElement('canvas');
        const ctx = finalCanvas.getContext('2d');
        const padding = 30;
        const titleHeight = 60;
        
        finalCanvas.width = canvas.width + (padding * 2);
        finalCanvas.height = canvas.height + padding + titleHeight;
        
        if (ctx) {
          // Fundo branco
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
          
          // Adicionar t√≠tulo da se√ß√£o
          ctx.fillStyle = '#1e40af';
          ctx.font = 'bold 24px Arial, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('An√°lise de Maturidade por Eixos', finalCanvas.width / 2, 35);
          
          // Adicionar subt√≠tulo
          ctx.fillStyle = '#6b7280';
          ctx.font = '16px Arial, sans-serif';
          ctx.fillText(`${selectedData.microrregiao}`, finalCanvas.width / 2, 55);
          
          // Adicionar o gr√°fico
          ctx.drawImage(canvas, padding, titleHeight);
          
          const imgData = finalCanvas.toDataURL('image/png');
          return `
            <div style="margin-bottom: 30px; page-break-inside: avoid;">
              <div style="text-align: center; page-break-inside: avoid;">
                <img src="${imgData}" style="max-width: 100%; max-height: 500px; height: auto; border: 1px solid #d1d5db; border-radius: 4px; object-fit: contain;" />
              </div>
              <div style="margin-top: 15px; text-align: center; font-size: 11px; color: #6b7280;">
                <p><strong>Escala:</strong> 0 (Inicial) ‚Üí 1 (Consolidado)</p>
                <p>Compara√ß√£o dos valores da microrregi√£o ${selectedData.microrregiao} versus mediana geral</p>
                <p><strong>Legenda:</strong> Azul = Microrregi√£o | Verde = Mediana Geral | Linhas pontilhadas = N√≠veis de refer√™ncia</p>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao capturar gr√°fico radar:', error);
      }
    }
    
    // Fallback para texto se n√£o conseguir capturar o gr√°fico
    return `
      <div style="margin-bottom: 30px; page-break-inside: avoid;">
        <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px; border-bottom: 2px solid #1e40af; padding-bottom: 5px;">
          An√°lise de Maturidade por Eixos - ${selectedData.microrregiao}
        </h3>
        <div style="background-color: #f9fafb; padding: 20px; border-radius: 6px; font-size: 12px;">
          <p style="margin: 0 0 15px 0; font-weight: bold; color: #1e40af;">Valores da microrregi√£o ${selectedData.microrregiao}:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Gest√£o e Governan√ßa:</strong> ${selectedData.eixo_1} (${(parseFloat(String(selectedData.eixo_1).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Infraestrutura e Conectividade:</strong> ${selectedData.eixo_2} (${(parseFloat(String(selectedData.eixo_2).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Sistemas e Dados:</strong> ${selectedData.eixo_3} (${(parseFloat(String(selectedData.eixo_3).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Capacita√ß√£o e Desenvolvimento:</strong> ${selectedData.eixo_4} (${(parseFloat(String(selectedData.eixo_4).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Servi√ßos Digitais:</strong> ${selectedData.eixo_5} (${(parseFloat(String(selectedData.eixo_5).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Interoperabilidade:</strong> ${selectedData.eixo_6} (${(parseFloat(String(selectedData.eixo_6).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
            <div style="padding: 8px; background: white; border-radius: 4px; border-left: 4px solid #1e40af;">
              <strong>Seguran√ßa e Privacidade:</strong> ${selectedData.eixo_7} (${(parseFloat(String(selectedData.eixo_7).replace(',', '.')) * 100).toFixed(1)}%)
            </div>
          </div>
        </div>
      </div>
    `;
  };

  const generateBarSection = async () => {
    const barElement = document.querySelector('[data-chart="bar"]');
    if (barElement && (barElement as HTMLElement).offsetWidth > 0) {
      try {
        const canvas = await html2canvas(barElement as HTMLElement, {
          scale: 1.5, // Reduzido para melhor performance
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: (barElement as HTMLElement).offsetWidth,
          height: (barElement as HTMLElement).offsetHeight,
          scrollX: 0,
          scrollY: 0,
          logging: false,
          removeContainer: true
        });
        const imgData = canvas.toDataURL('image/png');
        return `
          <div style="margin-bottom: 20px; page-break-inside: avoid;">
            <div style="text-align: center; page-break-inside: avoid;">
              <img src="${imgData}" style="max-width: 100%; max-height: 600px; height: auto; border: 1px solid #d1d5db; border-radius: 4px; object-fit: contain;" />
            </div>
            <div style="margin-top: 15px; text-align: center; font-size: 11px; color: #6b7280;">
              <p><strong>Ranking:</strong> Posi√ß√£o da microrregi√£o ${selectedData.microrregiao} no contexto geral</p>
              <p>Compara√ß√£o do √≠ndice de maturidade digital entre todas as microrregi√µes analisadas</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao capturar gr√°fico de barras:', error);
      }
    }
    
    // Fallback para texto se n√£o conseguir capturar o gr√°fico
    return `
      <div style="margin-bottom: 20px; page-break-inside: avoid;">
        <h3 style="color: #1e40af; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #1e40af; padding-bottom: 3px;">
          Ranking do √çndice Geral de Maturidade
        </h3>
        <div style="background-color: #f9fafb; padding: 15px; border-radius: 4px; font-size: 11px;">
          <p style="margin: 0 0 10px 0; font-weight: bold;">Top 10 microrregi√µes:</p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            ${data
              .sort((a, b) => parseFloat(String(b.indice_geral).replace(',', '.')) - parseFloat(String(a.indice_geral).replace(',', '.')))
              .slice(0, 10)
              .map((item, index) => `
                <div style="padding: 4px; ${item.microrregiao === selectedData.microrregiao ? 'background-color: #dbeafe; border-left: 3px solid #1e40af;' : ''}">
                  <strong>${index + 1}¬∫</strong> ${item.microrregiao}: ${parseFloat(String(item.indice_geral).replace(',', '.')).toFixed(3)}
                </div>
              `).join('')}
          </div>
        </div>
      </div>
    `;
  };

  const generateTableSection = () => `
    <div style="margin-bottom: 20px; page-break-inside: avoid;">
      <h3 style="color: #1e40af; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #1e40af; padding-bottom: 3px;">
        Detalhamento por Eixos de Maturidade
      </h3>
      <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
        <thead>
          <tr style="background-color: #1e40af; color: white;">
            <th style="padding: 6px; border: 1px solid #1e40af; text-align: left;">Eixo</th>
            <th style="padding: 6px; border: 1px solid #1e40af; text-align: center;">Valor</th>
            <th style="padding: 6px; border: 1px solid #1e40af; text-align: center;">Percentual</th>
            <th style="padding: 6px; border: 1px solid #1e40af; text-align: center;">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Gest√£o e Governan√ßa</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_1}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_1).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_1)};">${getStatusText(selectedData.eixo_1)}</td>
          </tr>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Infraestrutura e Conectividade</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_2}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_2).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_2)};">${getStatusText(selectedData.eixo_2)}</td>
          </tr>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Sistemas e Dados</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_3}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_3).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_3)};">${getStatusText(selectedData.eixo_3)}</td>
          </tr>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Capacita√ß√£o e Desenvolvimento</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_4}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_4).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_4)};">${getStatusText(selectedData.eixo_4)}</td>
          </tr>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Servi√ßos Digitais</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_5}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_5).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_5)};">${getStatusText(selectedData.eixo_5)}</td>
          </tr>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Interoperabilidade</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_6}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_6).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_6)};">${getStatusText(selectedData.eixo_6)}</td>
          </tr>
          <tr>
            <td style="padding: 6px; border: 1px solid #d1d5db; font-weight: bold;">Seguran√ßa e Privacidade</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${selectedData.eixo_7}</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center;">${(parseFloat(String(selectedData.eixo_7).replace(',', '.')) * 100).toFixed(1)}%</td>
            <td style="padding: 6px; border: 1px solid #d1d5db; text-align: center; background-color: ${getStatusColor(selectedData.eixo_7)};">${getStatusText(selectedData.eixo_7)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;

  const generatePopulationSection = async () => {
    const populationElement = document.querySelector('[data-chart="population"]');
    if (populationElement && (populationElement as HTMLElement).offsetWidth > 0) {
      try {
        const canvas = await html2canvas(populationElement as HTMLElement, {
          scale: 1.5, // Reduzido para melhor performance
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: (populationElement as HTMLElement).offsetWidth,
          height: (populationElement as HTMLElement).offsetHeight,
          scrollX: 0,
          scrollY: 0,
          logging: false,
          removeContainer: true
        });
        const imgData = canvas.toDataURL('image/png');
        return `
          <div style="margin-bottom: 20px; page-break-inside: avoid;">
            <div style="text-align: center; page-break-inside: avoid;">
              <img src="${imgData}" style="max-width: 100%; max-height: 600px; height: auto; border: 1px solid #d1d5db; border-radius: 4px; object-fit: avoid;" />
            </div>
            <div style="margin-top: 15px; text-align: center; font-size: 11px; color: #6b7280;">
              <p><strong>Distribui√ß√£o:</strong> Popula√ß√£o atendida por cada microrregi√£o</p>
              <p>An√°lise demogr√°fica e impacto populacional das iniciativas de maturidade digital</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao capturar gr√°fico de popula√ß√£o:', error);
      }
    }
    
    // Fallback para texto se n√£o conseguir capturar o gr√°fico
    return `
      <div style="margin-bottom: 20px; page-break-inside: avoid;">
        <h3 style="color: #1e40af; font-size: 14px; margin-bottom: 10px; border-bottom: 1px solid #1e40af; padding-bottom: 3px;">
          Distribui√ß√£o Populacional
        </h3>
        <div style="background-color: #f9fafb; padding: 15px; border-radius: 4px; font-size: 11px;">
          <p style="margin: 0 0 10px 0; font-weight: bold;">Popula√ß√£o da microrregi√£o ${selectedData.microrregiao}:</p>
          <div style="font-size: 16px; font-weight: bold; color: #1e40af; text-align: center; padding: 10px; background-color: #eff6ff; border-radius: 4px;">
            ${selectedData.populacao} habitantes
          </div>
          <p style="margin: 10px 0 0 0; font-size: 10px; color: #6b7280;">
            Representa ${((parseInt(String(selectedData.populacao).replace(/\./g, '')) / data.reduce((sum, item) => sum + parseInt(String(item.populacao).replace(/\./g, '')), 0)) * 100).toFixed(1)}% da popula√ß√£o total analisada
          </p>
        </div>
      </div>
    `;
  };

  const generateRecommendationsSection = () => {
    const eixos = [
      { nome: 'Gest√£o e Governan√ßa', valor: selectedData.eixo_1, situacao: selectedData.situacao_eixo_1, recomendacao: selectedData.recomendacao_eixo_1, ferramenta: selectedData.ferramenta_eixo_1 },
      { nome: 'Infraestrutura e Conectividade', valor: selectedData.eixo_2, situacao: selectedData.situacao_eixo_2, recomendacao: selectedData.recomendacao_eixo_2, ferramenta: selectedData.ferramenta_eixo_2 },
      { nome: 'Sistemas e Dados', valor: selectedData.eixo_3, situacao: selectedData.situacao_eixo_3, recomendacao: selectedData.recomendacao_eixo_3, ferramenta: selectedData.ferramenta_eixo_3 },
      { nome: 'Capacita√ß√£o e Desenvolvimento', valor: selectedData.eixo_4, situacao: selectedData.situacao_eixo_4, recomendacao: selectedData.recomendacao_eixo_4, ferramenta: selectedData.ferramenta_eixo_4 },
      { nome: 'Servi√ßos Digitais', valor: selectedData.eixo_5, situacao: selectedData.situacao_eixo_5, recomendacao: selectedData.recomendacao_eixo_5, ferramenta: selectedData.ferramenta_eixo_5 },
      { nome: 'Interoperabilidade', valor: selectedData.eixo_6, situacao: selectedData.situacao_eixo_6, recomendacao: selectedData.recomendacao_eixo_6, ferramenta: selectedData.ferramenta_eixo_6 },
      { nome: 'Seguran√ßa e Privacidade', valor: selectedData.eixo_7, situacao: selectedData.situacao_eixo_7, recomendacao: selectedData.recomendacao_eixo_7, ferramenta: selectedData.ferramenta_eixo_7 }
    ];



    // Retornar todos os eixos em uma √∫nica string
    return `
      <div style="margin-bottom: 20px; page-break-inside: avoid;">
        <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
          <h3 style="color: white; font-size: 14px; margin: 0; font-weight: bold;">
            üìã Recomenda√ß√µes por Eixo de Maturidade - ${selectedData.microrregiao}
          </h3>
        </div>
          ${eixos.map((eixo, index) => `
          <div style="margin-bottom: 15px; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.1); background-color: #ffffff;">
            <div style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 10px; font-weight: bold; font-size: 12px; display: flex; justify-content: space-between; align-items: center;">
                <span>Eixo ${index + 1} ‚Äì ${eixo.nome}</span>
                <span style="background-color: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-size: 10px;">${parseFloat(String(eixo.valor).replace(',', '.')).toFixed(3)}</span>
            </div>
            <div style="padding: 12px; font-size: 10px;">
              
              <!-- Situa√ß√£o Atual -->
              <div style="margin-bottom: 12px; background-color: #fef3c7; padding: 10px; border-radius: 6px; border-left: 3px solid #f59e0b;">
                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                  <span style="background-color: #f59e0b; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 6px;">!</span>
                  <strong style="color: #92400e; font-size: 11px;">Situa√ß√£o Atual</strong>
                </div>
                <p style="margin: 0; line-height: 1.4; color: #78350f; font-size: 9px;">${eixo.situacao || 'Informa√ß√£o n√£o dispon√≠vel'}</p>
              </div>
              
              <!-- Recomenda√ß√£o -->
              <div style="margin-bottom: 12px; background-color: #dbeafe; padding: 10px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                  <span style="background-color: #3b82f6; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 6px;">‚Üí</span>
                  <strong style="color: #1e40af; font-size: 11px;">Recomenda√ß√£o</strong>
                </div>
                <div style="line-height: 1.4; color: #1e3a8a; font-size: 9px;">
                  ${eixo.recomendacao ? eixo.recomendacao.split('\n').map((line, idx) => 
                    line.trim().startsWith('**') ? 
                      `<div style="margin: 6px 0; padding: 6px; background-color: rgba(59,130,246,0.1); border-radius: 3px; font-weight: bold;">${line.replace(/\*\*/g, '')}</div>` :
                      `<p style="margin: 3px 0;">${line}</p>`
                  ).join('') : 'Informa√ß√£o n√£o dispon√≠vel'}
                </div>
              </div>
              
              <!-- Ferramenta Sugerida -->
              <div style="background-color: #d1fae5; padding: 10px; border-radius: 6px; border-left: 3px solid #10b981;">
                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                  <span style="background-color: #10b981; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 6px;">‚úì</span>
                  <strong style="color: #065f46; font-size: 11px;">Ferramenta Sugerida</strong>
                </div>
                <p style="margin: 0; line-height: 1.4; color: #064e3b; font-size: 9px;">${eixo.ferramenta || 'Informa√ß√£o n√£o dispon√≠vel'}</p>
              </div>
              
            </div>
          </div>
        `).join('')}
      </div>
    `;
  };

  const getStatusColor = (valor: string): string => {
    const num = parseFloat(String(valor).replace(',', '.'));
    if (num > 0.66) return '#dcfce7'; // Verde claro
    if (num > 0.33) return '#fef3c7'; // Amarelo claro
    return '#fee2e2'; // Vermelho claro
  };

  const getStatusText = (valor: string): string => {
    const num = parseFloat(String(valor).replace(',', '.'));
    if (num > 0.66) return 'Consolidado';
    if (num > 0.33) return 'Em Evolu√ß√£o';
    return 'Inicial';
  };

  const generateStatsPage = () => `
    <div style="text-align: center; margin-bottom: 30px;">
      <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
        Estat√≠sticas Gerais
      </h1>
      <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
        Microrregi√£o: ${selectedData.microrregiao}
      </h2>
    </div>
    ${generateHeaderSection()}
    ${generateStatsSection()}
    <div style="margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
      <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px;">Explica√ß√£o dos Indicadores:</h3>
      <p style="font-size: 14px; line-height: 1.6; color: #374151;">
        <strong>√çndice Geral:</strong> Representa a m√©dia ponderada de todos os eixos de maturidade digital.<br>
        <strong>Status:</strong> Classifica a microrregi√£o em Emergente (‚â§0.33), Em Evolu√ß√£o (0.33-0.66) ou Avan√ßado (>0.66).<br>
        <strong>Popula√ß√£o:</strong> Total de habitantes da microrregi√£o.<br>
        <strong>Munic√≠pios:</strong> N√∫mero de cidades que comp√µem a microrregi√£o.
      </p>
    </div>
  `;

  const generateRadarPage = async () => {
    const radarElement = document.querySelector('.recharts-wrapper');
    if (radarElement && (radarElement as HTMLElement).offsetWidth > 0) {
      try {
        const canvas = await html2canvas(radarElement as HTMLElement, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: (radarElement as HTMLElement).offsetWidth,
          height: (radarElement as HTMLElement).offsetHeight,
          scrollX: 0,
          scrollY: 0,
          logging: false,
          removeContainer: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        return `
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
              An√°lise de Maturidade por Eixos
            </h1>
            <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
              Microrregi√£o: ${selectedData.microrregiao}
            </h2>
          </div>
          <div style="text-align: center; margin-bottom: 30px;">
            <img src="${imgData}" style="max-width: 100%; max-height: 400px; height: auto; border: 2px solid #d1d5db; border-radius: 8px;" />
          </div>
          <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">Como interpretar este gr√°fico:</h3>
            <div style="font-size: 14px; line-height: 1.8; color: #374151; text-align: left;">
              <p><strong>üîµ Linha AZUL:</strong> Valores da microrregi√£o selecionada (${selectedData.microrregiao})</p>
              <p><strong>üü¢ Linha VERDE:</strong> Mediana geral de todas as microrregi√µes analisadas</p>
              <p><strong>üî¥ Linhas pontilhadas:</strong> N√≠veis de refer√™ncia para compara√ß√£o</p>
              <ul style="margin-left: 20px;">
                <li><strong>Vermelho pontilhado:</strong> N√≠vel Emergente (‚â§33% - 0.33)</li>
                <li><strong>Laranja pontilhado:</strong> N√≠vel Em Evolu√ß√£o (33%-66% - 0.33-0.66)</li>
                <li><strong>Verde pontilhado:</strong> N√≠vel Avan√ßado (>66% - 0.66)</li>
              </ul>
              <p><strong>üìä Escala:</strong> 0 = Inicial (sem maturidade) ‚Üí 1 = Consolidado (maturidade completa)</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao capturar gr√°fico radar:', error);
      }
    }
    
    return `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
          An√°lise de Maturidade por Eixos
        </h1>
        <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
          Microrregi√£o: ${selectedData.microrregiao}
        </h2>
      </div>
      ${generateRadarSection()}
    `;
  };

  const generateBarPage = async () => {
    const barElement = document.querySelector('[data-chart="bar"]');
    if (barElement && (barElement as HTMLElement).offsetWidth > 0) {
      try {
        const canvas = await html2canvas(barElement as HTMLElement, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: (barElement as HTMLElement).offsetWidth,
          height: (barElement as HTMLElement).offsetHeight,
          scrollX: 0,
          scrollY: 0,
          logging: false,
          removeContainer: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        return `
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
              Ranking do √çndice Geral
            </h1>
            <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
              Microrregi√£o: ${selectedData.microrregiao}
            </h2>
          </div>
          <div style="text-align: center; margin-bottom: 30px;">
            <img src="${imgData}" style="max-width: 100%; max-height: 400px; height: auto; border: 2px solid #d1d5db; border-radius: 8px;" />
          </div>
          <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px;">
            <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">Explica√ß√£o do Ranking:</h3>
            <div style="font-size: 14px; line-height: 1.8; color: #374151; text-align: left;">
              <p><strong>üìä Objetivo:</strong> Mostrar a posi√ß√£o da microrregi√£o selecionada no contexto geral</p>
              <p><strong>üéØ Compara√ß√£o:</strong> Permite visualizar como a microrregi√£o se posiciona em rela√ß√£o √†s demais</p>
              <p><strong>üìà Interpreta√ß√£o:</strong> Quanto maior a barra, melhor o √≠ndice de maturidade digital</p>
              <p><strong>üîç Destaque:</strong> A microrregi√£o selecionada aparece destacada para f√°cil identifica√ß√£o</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao capturar gr√°fico de barras:', error);
      }
    }
    
    return `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
          Ranking do √çndice Geral
        </h1>
        <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
          Microrregi√£o: ${selectedData.microrregiao}
        </h2>
      </div>
      ${generateBarSection()}
    `;
  };

  const generateTablePage = () => `
    <div style="text-align: center; margin-bottom: 30px;">
      <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
        Tabela Detalhada por Eixos
      </h1>
      <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
        Microrregi√£o: ${selectedData.microrregiao}
      </h2>
    </div>
    ${generateHeaderSection()}
    ${generateTableSection()}
    <div style="margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
      <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px;">Explica√ß√£o dos Eixos:</h3>
      <div style="font-size: 14px; line-height: 1.6; color: #374151;">
        <p><strong>Eixo 1 - Gest√£o e Governan√ßa:</strong> Estruturas organizacionais e pol√≠ticas de TI</p>
        <p><strong>Eixo 2 - Infraestrutura e Conectividade:</strong> Recursos tecnol√≥gicos e conectividade</p>
        <p><strong>Eixo 3 - Sistemas e Dados:</strong> Gest√£o de sistemas e qualidade dos dados</p>
        <p><strong>Eixo 4 - Capacita√ß√£o e Desenvolvimento:</strong> Treinamento e desenvolvimento de compet√™ncias</p>
        <p><strong>Eixo 5 - Servi√ßos Digitais:</strong> Disponibiliza√ß√£o de servi√ßos online</p>
        <p><strong>Eixo 6 - Interoperabilidade:</strong> Integra√ß√£o entre sistemas e servi√ßos</p>
        <p><strong>Eixo 7 - Seguran√ßa e Privacidade:</strong> Prote√ß√£o de dados e seguran√ßa da informa√ß√£o</p>
      </div>
    </div>
  `;

  const generatePopulationPage = async () => {
    const populationElement = document.querySelector('[data-chart="population"]');
    if (populationElement && (populationElement as HTMLElement).offsetWidth > 0) {
      try {
        const canvas = await html2canvas(populationElement as HTMLElement, {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          width: (populationElement as HTMLElement).offsetWidth,
          height: (populationElement as HTMLElement).offsetHeight,
          scrollX: 0,
          scrollY: 0,
          logging: false,
          removeContainer: true
        });
        
        const imgData = canvas.toDataURL('image/png');
        return `
          <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
              An√°lise Demogr√°fica
            </h1>
            <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
              Microrregi√£o: ${selectedData.microrregiao}
            </h2>
          </div>
          ${generateHeaderSection()}
          <div style="text-align: center; margin-bottom: 30px;">
            <img src="${imgData}" style="max-width: 100%; max-height: 400px; height: auto; border: 2px solid #d1d5db; border-radius: 8px;" />
          </div>
          <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px;">
            <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">Contexto Demogr√°fico:</h3>
            <div style="font-size: 14px; line-height: 1.8; color: #374151; text-align: left;">
              <p><strong>üë• Popula√ß√£o Total:</strong> ${selectedData.populacao} habitantes</p>
              <p><strong>üèôÔ∏è Munic√≠pios:</strong> ${selectedData.municipios} cidades</p>
              <p><strong>üìä Densidade:</strong> M√©dia populacional por munic√≠pio</p>
              <p><strong>üéØ Relev√¢ncia:</strong> O tamanho da popula√ß√£o influencia a complexidade da gest√£o digital</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao capturar gr√°fico de popula√ß√£o:', error);
      }
    }
    
    return `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
          An√°lise Demogr√°fica
        </h1>
        <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
          Microrregi√£o: ${selectedData.microrregiao}
        </h2>
      </div>
      ${generateHeaderSection()}
      ${generatePopulationSection()}
    `;
  };

  const generateRecommendationsPage = () => `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
          Recomenda√ß√µes por Eixo
        </h1>
        <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
          Microrregi√£o: ${selectedData.microrregiao}
        </h2>
      </div>
      ${generateHeaderSection()}
      ${generateRecommendationsSection()}
      <div style="margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
        <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px;">Como usar as recomenda√ß√µes:</h3>
        <div style="font-size: 14px; line-height: 1.6; color: #374151;">
          <p><strong>üéØ Prioriza√ß√£o:</strong> Foque primeiro nos eixos com menor pontua√ß√£o</p>
          <p><strong>üìà Evolu√ß√£o:</strong> As recomenda√ß√µes s√£o baseadas no n√≠vel atual de maturidade</p>
          <p><strong>üîÑ Iterativo:</strong> Implemente gradualmente e monitore o progresso</p>
          <p><strong>ü§ù Colabora√ß√£o:</strong> Envolva diferentes setores na implementa√ß√£o</p>
        </div>
      </div>
    `;
  };

  const generateExecutivePage = () => {
    const indiceGeral = parseFloat(String(selectedData.indice_geral).replace(',', '.'));
    const classification = indiceGeral > 0.66 ? 'Consolidado' : indiceGeral > 0.33 ? 'Em Evolu√ß√£o' : 'Emergente';
    
    return `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
          Dashboard Executivo
        </h1>
        <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
          Microrregi√£o: ${selectedData.microrregiao}
        </h2>
      </div>
      ${generateHeaderSection()}
      
      <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">Resumo Executivo</h3>
        <div style="font-size: 14px; line-height: 1.8; color: #374151;">
          <p><strong>√çndice Geral de Maturidade:</strong> ${(indiceGeral * 100).toFixed(1)}%</p>
          <p><strong>Classifica√ß√£o:</strong> ${classification}</p>
          <p><strong>Status:</strong> ${selectedData.microrregiao} est√° em processo de evolu√ß√£o digital</p>
        </div>
      </div>
      
      <div style="margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
        <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px;">Recomenda√ß√£o Estrat√©gica:</h3>
        <div style="font-size: 14px; line-height: 1.6; color: #374151;">
          <p>${selectedData.microrregiao} demonstra maturidade digital ${classification.toLowerCase()}. 
          Priorize os eixos emergentes e fortale√ßa as √°reas j√° em desenvolvimento para acelerar a transforma√ß√£o digital.</p>
        </div>
      </div>
    `;
  };

  const generateAdvancedPage = () => `
    <div style="text-align: center; margin-bottom: 30px;">
      <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
        An√°lise Avan√ßada
      </h1>
      <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
        Microrregi√£o: ${selectedData.microrregiao}
      </h2>
    </div>
    ${generateHeaderSection()}
    
    <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
      <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">Compara√ß√£o entre Regi√µes</h3>
      <div style="font-size: 14px; line-height: 1.8; color: #374151;">
        <p><strong>Funcionalidade:</strong> Esta se√ß√£o permite comparar ${selectedData.microrregiao} com outras microrregi√µes</p>
        <p><strong>An√°lise:</strong> Gr√°ficos radar, barras e resumo executivo comparativo</p>
        <p><strong>Insights:</strong> Identifica√ß√£o de pontos fortes e oportunidades de melhoria</p>
      </div>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
      <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px;">Como usar a An√°lise Avan√ßada:</h3>
      <div style="font-size: 14px; line-height: 1.6; color: #374151;">
        <p><strong>üîç Sele√ß√£o:</strong> Escolha uma regi√£o para compara√ß√£o</p>
        <p><strong>üìä Visualiza√ß√£o:</strong> Use diferentes tipos de gr√°ficos para an√°lise</p>
        <p><strong>üìà M√©tricas:</strong> Compare √≠ndices e pontua√ß√µes por eixo</p>
        <p><strong>üéØ Estrat√©gia:</strong> Baseie decis√µes em dados comparativos</p>
      </div>
    </div>
  `;

  const generateEixosDetailPage = () => {
    const eixosNames = [
      'Gest√£o e Governan√ßa',
      'Infraestrutura e Conectividade', 
      'Sistemas e Dados',
      'Capacita√ß√£o e Desenvolvimento',
      'Servi√ßos Digitais',
      'Interoperabilidade',
      'Seguran√ßa e Privacidade'
    ];

    let eixosContent = '';
    for (let i = 1; i <= 7; i++) {
      const eixoKey = `eixo_${i}` as keyof MicroRegionData;
      const valor = parseFloat(String(selectedData[eixoKey]).replace(',', '.'));
      const status = valor > 0.66 ? 'Avan√ßado' : valor > 0.33 ? 'Em Evolu√ß√£o' : 'Emergente';
      const statusColor = valor > 0.66 ? '#10b981' : valor > 0.33 ? '#f59e0b' : '#eab308';
      
      eixosContent += `
        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background-color: #ffffff;">
          <h4 style="color: #1e40af; font-size: 16px; margin-bottom: 10px; font-weight: bold;">
            Eixo ${i} - ${eixosNames[i-1]}
          </h4>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-size: 14px; color: #374151;">Pontua√ß√£o: <strong>${(valor * 100).toFixed(1)}%</strong></span>
            <span style="font-size: 14px; color: ${statusColor}; font-weight: bold;">${status}</span>
          </div>
          <div style="background-color: #f3f4f6; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="width: ${valor * 100}%; height: 100%; background-color: ${statusColor};"></div>
          </div>
        </div>
      `;
    }

    return `
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #1e40af; font-size: 28px; margin-bottom: 20px; font-weight: bold;">
          Detalhamento por Eixos de Maturidade
        </h1>
        <h2 style="color: #374151; font-size: 20px; margin-bottom: 15px;">
          Microrregi√£o: ${selectedData.microrregiao}
        </h2>
      </div>
      ${generateHeaderSection()}
      
      <div style="background-color: #f8fafc; padding: 25px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px;">An√°lise Detalhada por Eixo</h3>
        ${eixosContent}
      </div>
      
      <div style="margin-top: 30px; padding: 20px; background-color: #f8fafc; border-radius: 8px;">
        <h3 style="color: #1e40af; font-size: 16px; margin-bottom: 15px;">Legenda de Status:</h3>
        <div style="font-size: 14px; line-height: 1.6; color: #374151;">
          <p><strong style="color: #10b981;">üü¢ Avan√ßado (80-100%):</strong> N√≠vel alto de maturidade digital</p>
          <p><strong style="color: #f59e0b;">üü° Em Evolu√ß√£o (50-79%):</strong> N√≠vel intermedi√°rio de desenvolvimento</p>
          <p><strong style="color: #eab308;">üü° Emergente (20-49%):</strong> N√≠vel b√°sico de maturidade</p>
          <p><strong style="color: #ef4444;">üî¥ Inicial (0-19%):</strong> Necessita de desenvolvimento priorit√°rio</p>
        </div>
      </div>
    `;
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>
        <Button 
          className="bg-primary hover:bg-primary/90 text-white shadow-lg"
          size="lg"
        >
          <Download className="h-4 w-4 mr-2" />
          Baixar Relat√≥rio PDF
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-md bg-blue-50 border-blue-200">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Settings className="h-5 w-5" />
            Configurar Relat√≥rio PDF
          </DialogTitle>
        </DialogHeader>
        
        <div className="space-y-4">
          <div className="flex items-center space-x-2">
            <Checkbox 
              id="select-all"
              checked={sections.every(s => s.checked)}
              onCheckedChange={handleSelectAll}
            />
            <Label htmlFor="select-all" className="font-semibold">
              Selecionar Todos
            </Label>
          </div>
          
          <div className="space-y-3">
            {sections.map((section) => (
              <div key={section.id} className="flex items-center space-x-2">
                <Checkbox 
                  id={section.id}
                  checked={section.checked}
                  onCheckedChange={(checked) => handleSectionChange(section.id, checked as boolean)}
                />
                <Label htmlFor={section.id} className="text-sm">
                  {section.label}
                </Label>
              </div>
            ))}
          </div>
          
          {isGenerating && (
            <div className="pt-2 text-center">
              <p className="text-sm text-blue-600 font-medium">{generationProgress}</p>
            </div>
          )}
          
          <div className="pt-4 border-t">
            <Button 
              onClick={generatePDF}
              className="w-full"
              disabled={!sections.some(s => s.checked) || isGenerating}
            >
              {isGenerating ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Gerando PDF...
                </>
              ) : (
                <>
              <FileText className="h-4 w-4 mr-2" />
              Gerar PDF
                </>
              )}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  );
} 